# Prepd-project

Prepd-project is a set of Ansible playbooks which when combined with these
[Ansible roles](https://github.com/rjayroach/ansible-roles/) provides a set of infrastructure blueprints
for development, staging and production in which to deploy a project with one or more applications

The blueprints provide a stand-alone provisioning system based on Ansible, however
when they are managed with the Prepd gem, project and application setup becomes fully automated.

Regardless of whether Prepd is used to manage the blueprints, Ansible playbooks are the primary tool used to
provision the infrastructure across four specific environments: local, devleopment, staging and production


## Default infrastructure

The Vagrantfile (for local) and the Ansible playbooks (for all other environments) provision a Default Infrastructure
which creates a 3 node cluster with basic serivces

- node0: This is the primary machine for development and management of cluster services
- node1-3: These are cluster nodes

node0 can run without other nodes


## Roles

### Dev

This includes only node0 in the 'dev' role

- node0: a 'master' machine for development, testing, building images, load balancing and managing a docker swarm cluster

### Cluster

This includes node0 in the 'master' role

- node0: Consul Server, Registrator, Nginx (ELB)
- node1: Consul, Registrator, Postgresql (RDS)
- node2: Consul, Registrator, Redis (Elasticache)
- node3: Consul, Registrator, DynamoDB

## Environments

### Local and Development

Local (vagrant) and Development (AWS) have common functionality in that they can both implement either 'dev' or 'dev' and 'cluster' roles
When just using the 'dev' role then it is a single machine with the applications and the supporting services, e.g. PG, Redis, etc.

However, when the 'cluster' role is applied a docker swarm network is created to emulate a cluster running on cloud (AWS) resources in production


### Staging and Production

This assumes that supporting services may be installed using AWS (RDS, Elasticache, etc) or as services installed directly on EC2s or as docker
containers


## Supporting Services

Can be updated in run/docker-compose.yml
TODO: List consul DNS names where the above services are reachable

### Project Infrastructure

Project is defined in run/docker-compose.override.yml See [docker](https://docs.docker.com/compose/extends/)
- Rails container exposing HTTP via Puma (default)
- Rails container override CMD to run Resque
- Rails container override CMD to run Scheduler
- Ember app


## Installing

```bash
git clone git@github.com:rjayroach/prepd-project.git
cd prepd-project/ansible
git submodule add git@github.com:rjayroach/ansible-roles roles
```

## Configuration

### Project Variables

Variables are stored in an environment sub-directory of the inventory/group_vars directory
in either plain text (vars.yml) or encrypted (vault)

Examples:
- vars that apply to the local environment are set in inventory/group_vars/local/vars.yml
- encrypted vars that apply to all environemnts are set in inventory/group_vars/all/vault
- vars that apply to dev (local and development) are set in inventory/group_vars/dev/vars.yml

inventory/group_vars/dev/vars.yml is where the source code repositories and other dev related info is stored

### Encrypted Variables
When generating a new project, prepd will generate a uuid as a secret passphrase to .vault_pass.txt
Encrypted files are encrypted with the pass phrase in project_root/.vault_pass.txt
This file is listed in .gitignore so it is never committed to the repository
Ansible's config (ansible.cfg) is setup to use the passphrase when dealing with encrypted data
Use ansible-vault to edit an encrypted file, e.g.:

```bash
cd ansible
ansible-vault edit inventory/group_vars/all/vault
```

### Application Variables
App vars (plain text and encrypted) are merged together into a single dictionary hash in app-development.yml
The top level key into the dictionary is the application name.
The template generated by prepd contains two samples 'cool_app_1' and 'cool_app_2'
If there is only one application then remove references to 'cool_app_2' and change the name 'cool_app_1'
to the application name
This also needs to be done in each of the environment vars.yml and vault files

## Using

### Connect to local machine

```bash
vagrant up
vagrant ssh node0 OR ssh -4 -A vagrant@node0.{project_name}.local
cd {project_name}/ansible
./dev.yml # run the role configuration manually (this is automatically run when the machine is first created by Ansible)
```


## Examples

### Database Backup and Restore


